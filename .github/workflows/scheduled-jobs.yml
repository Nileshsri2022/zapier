# Scheduled Jobs - Cron triggers for Processor, Worker, and Cleanup
# Runs every 5 minutes to trigger processing

name: Scheduled Jobs

on:
  schedule:
    # Every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  # ============================================
  # TRIGGER PROCESSOR
  # ============================================
  trigger-processor:
    name: Trigger Kafka Processor
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Processor
        run: |
          curl -X POST "${{ secrets.PROCESSOR_URL }}/process" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 30 \
            --retry 2

  # ============================================
  # TRIGGER WORKER
  # ============================================
  trigger-worker:
    name: Trigger Email Worker
    runs-on: ubuntu-latest
    needs: trigger-processor # Run after processor
    steps:
      - name: Trigger Worker
        run: |
          curl -X POST "${{ secrets.WORKER_URL }}/process" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 60 \
            --retry 2

  # ============================================
  # DAILY CLEANUP
  # ============================================
  cleanup:
    name: Daily Cleanup
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 0 * * *' # Only at midnight UTC
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Generate Prisma Client
        run: cd packages/db && bunx prisma generate

      - name: Run Cleanup
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          node -e "
            const client = require('@repo/db').default;
            
            async function cleanup() {
              // Delete old completed ZapRuns (older than 30 days)
              const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
              
              const deleted = await client.zapRun.deleteMany({
                where: {
                  createdAt: { lt: thirtyDaysAgo }
                }
              });
              
              console.log('Deleted', deleted.count, 'old ZapRun records');
              
              // Delete orphaned outbox entries
              const orphaned = await client.zapRunOutbox.deleteMany({
                where: {
                  zapRun: null
                }
              });
              
              console.log('Deleted', orphaned.count, 'orphaned outbox entries');
            }
            
            cleanup().then(() => process.exit(0)).catch(e => { console.error(e); process.exit(1); });
          "
